if DARWIN
  AM_CFLAGS = -arch i386 -arch ppc
  TIGER_CFLAG = -isysroot /Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4
  TIGER_LDFLAG = -Wl,-syslibroot,/Developer/SDKs/MacOSX10.4u.sdk -mmacosx-version-min=10.4 -headerpad_max_install_names
  LEOPARD_CFLAG = -isysroot /Developer/SDKs/MacOSX10.5.sdk -mmacosx-version-min=10.5
  LEOPARD_LDFLAG = -Wl,-syslibroot,/Developer/SDKs/MacOSX10.5.sdk -mmacosx-version-min=10.5 -headerpad_max_install_names
  DARWINFLAGS = -undefined dynamic_lookup
  SYSFLAGS = -DIBM=0 -DAPL=1 -DLIN=0
  #If ltr_server is not linked against CoreFoundation, loading libusb-1.0 would
  #  cause SIG_TRAP, since CoreFoundation expects the init takes place 
  #  in the main thread. Linking ltr_server against CoreFoundation solves that.
  LTR_SERVER_FLAGS = -framework CoreFoundation
if SNOW_LEOPARD
  QMAKE_FLAGS = -spec macx-g++40
else
  QMAKE_FLAGS = -spec macx-g++
endif

else
  AM_CFLAGS = 
  LINUXFLAGS = '-Wl,-rpath,$(pkglibdir)' '-DLIB_PATH="$(pkglibdir)/"'
  SYSFLAGS = -DIBM=0 -DAPL=0 -DLIN=1 -L/lib32 -L/usr/lib32
  QMAKE_FLAGS = -spec linux-g++
  LIBLINUXTRACK_FLAGS = -fpic -fPIC
  LTR_SERVER_FLAGS = 
endif

man_MANS = ltr_gui.1 ltr_server.1

lib_LTLIBRARIES = liblinuxtrack.la
pkglib_LTLIBRARIES = libltr.la libmacwii.la
bin_PROGRAMS = ltr_server ltr_server1

ltr_server_SOURCES = ltr_server.c ipc_utils.c ipc_utils.h utils.c utils.h
ltr_server_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} $(LINUXFLAGS)
ltr_server_LDADD = -lpthread libltr.la
ltr_server_LDFLAGS = $(LINUXFLAGS) ${TIGER_LDFLAG} ${LTR_SERVER_FLAGS}

ltr_server1_SOURCES = ltr_srv_comm.c ltr_srv_comm.h ltr_srv_slave.c ltr_srv_slave.h \
	ltr_srv_master.cpp ltr_srv_master.h ltr_server1.c
ltr_server1_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} $(LINUXFLAGS)
ltr_server1_LDADD = -lpthread libltr.la
ltr_server1_LDFLAGS = $(LINUXFLAGS) ${TIGER_LDFLAG} ${LTR_SERVER_FLAGS}
	


if CWIID
  pkglib_LTLIBRARIES += libwii.la
  man_MANS += wii_server.1
endif

if V4L2
if LIBV4L2
  pkglib_LTLIBRARIES += libwc.la
if FACE_TRACKER
  pkglib_LTLIBRARIES += libft.la
endif
endif 
endif

#if LIBUSB
#  pkglib_LTLIBRARIES += libtir4.la 
#endif

if LIBZ
pkglib_LTLIBRARIES += libtir.la
if LIBUSB10
  pkglib_LTLIBRARIES += libltusb1.la 
endif

if OPENUSB
  pkglib_LTLIBRARIES += libltopenusb.la 
endif
endif

pkglib_LTLIBRARIES += libfakeusb.la

#bin_PROGRAMS = lt_server lt_client
#lt_server_SOURCES = lt_server.c netcomm.c netcomm.h
#lt_server_LDADD = -lm -lpthread -ldl libltr.la 
#lt_client_SOURCES = lt_client.c netcomm.c netcomm.h
#lt_client_LDADD = -lm -lpthread -ldl libltr.la 

linuxtrack.c : linuxtrack_pre.c linuxtrack.h utils.h ipc_utils.h utils.c ipc_utils.c ltlib.c ltlib.h
	cat linuxtrack_pre.c utils.h ipc_utils.h ltlib.h utils.c ipc_utils.c ltlib.c > linuxtrack.c

include_HEADERS = linuxtrack.h

#liblinuxtrack_la_SOURCES = ltlib.c linuxtrack.h utils.c utils.h list.c list_h dyn_load.c dyn_load.h
#liblinuxtrack_la_SOURCES = ltlib.c linuxtrack.h utils.c utils.h dyn_load.c dyn_load.h
liblinuxtrack_la_SOURCES = linuxtrack.c linuxtrack.h utils.h ipc_utils.h
liblinuxtrack_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} $(LIBLINUXTRACK_FLAGS) 
liblinuxtrack_la_LDFLAGS = -export-symbols "${srcdir}/liblt.sym" ${TIGER_LDFLAG}

libltr_la_SOURCES = cal.c cal.h list.c list.h dyn_load.c dyn_load.h\
  math_utils.c math_utils.h pose.c pose.h pref.c pref.h pref_bison.y \
  pref_flex.l pref_global.c pref_global.h pref_int.h \
  utils.c utils.h image_process.c image_process.h tracking.c tracking.h \
  ltlib_int.c ltlib_int.h spline.c spline.h axis.c axis.h wii_driver_prefs.c \
  wii_driver_prefs.h tir_driver_prefs.c tir_driver_prefs.h wc_driver_prefs.c \
  wc_driver_prefs.h ipc_utils.c ipc_utils.h com_proc.c com_proc.h wii_com.c wii_com.h
libltr_la_LIBADD = -lm -lpthread -ldl
libltr_la_LDFLAGS = -export-symbols-regex '^ltr_int' $(LINUXFLAGS) ${TIGER_LDFLAG}
libltr_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} $(LINUXFLAGS)
#libtir4_la_SOURCES = tir4_driver.c tir4_driver.h new_cal.c new_cal.h
#libtir4_la_LIBADD = -lusb  libltr.la

libtir_la_SOURCES = tir.h tir_hw.c tir_hw.h \
    tir_img.c tir_img.h usb_ifc.h tir_driver.h tir_driver.c runloop.c runloop.h
libtir_la_LIBADD = -lz libltr.la
libtir_la_LDFLAGS = -export-symbols "${srcdir}/tir.sym" $(LINUXFLAGS) ${TIGER_LDFLAG}

libltusb1_la_SOURCES = libusb_ifc.c usb_ifc.h
libltusb1_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS}
libltusb1_la_LIBADD = -lusb-1.0 libltr.la
libltusb1_la_LDFLAGS = ${TIGER_LDFLAG} $(LINUXFLAGS)
libltopenusb_la_SOURCES = openusb_ifc.c usb_ifc.h
libltopenusb_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS}
libltopenusb_la_LIBADD = -lopenusb libltr.la
libltopenusb_la_LDFLAGS = ${TIGER_LDFLAG} $(LINUXFLAGS)
libfakeusb_la_SOURCES = fakeusb.c usb_ifc.h
libfakeusb_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS}
libfakeusb_la_LIBADD = libltr.la
libfakeusb_la_LDFLAGS = ${TIGER_LDFLAG} $(LINUXFLAGS)

libwii_la_SOURCES = wiimote_driver.c wiimote_driver.h runloop.c runloop.h
libwii_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS}
libwii_la_LIBADD = -lcwiid libltr.la
libwii_la_LDFLAGS = -export-symbols "${srcdir}/drivers.sym" ${TIGER_LDFLAG} $(LINUXFLAGS)

libmacwii_la_SOURCES = macwii_driver.c wii_com.h com_proc.h \
  runloop.c runloop.h wii_driver_prefs.c wii_driver_prefs.h ipc_utils.h
libmacwii_la_CFLAGS = ${AM_CFLAGS} ${TIGER_CFLAG} -I${srcdir} -I${srcdir}/mac -I..
libmacwii_la_LIBADD = libltr.la
libmacwii_la_LDFLAGS = -export-symbols drivers.sym ${AM_CFLAGS} ${TIGER_LDFLAG}

libwc_la_SOURCES = webcam_driver.c webcam_driver.h runloop.c runloop.h
libwc_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS}
libwc_la_LIBADD = libltr.la -lv4l2
libwc_la_LDFLAGS = -export-symbols "${srcdir}/webcam_driver.sym" ${TIGER_LDFLAG} $(LINUXFLAGS)

libft_la_SOURCES = webcam_driver.c webcam_driver.h runloop.c runloop.h facetrack.cpp facetrack.h
libft_la_CFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} -DOPENCV $(OPENCV_CFLAGS)
libft_la_CXXFLAGS = ${TIGER_CFLAG} ${AM_CFLAGS} -DOPENCV $(OPENCV_CFLAGS)
libft_la_LIBADD = libltr.la -lv4l2 $(OPENCV_LIBS)
libft_la_LDFLAGS = -export-symbols "${srcdir}/webcam_driver.sym" ${TIGER_LDFLAG} $(LINUXFLAGS)

dist_pkgdata_DATA = linuxtrack.conf 51-TIR.rules linuxtrack.c

if XPLANE_PLUGIN
if LTR32ON64
  pkglib_LTLIBRARIES += xlinuxtrack.la xlinuxtrack9.la
  xlinuxtrack_la_SOURCES = xlinuxtrack.c xlinuxtrack_pref.c xlinuxtrack_pref.h \
			    linuxtrack.c
  xlinuxtrack_la_CFLAGS = -I${XPLANE_SDK}/XPLM -I${XPLANE_SDK}/Widgets $(SYSFLAGS) -fPIC -m32 $(DARWINCFLAGS) ${TIGER_CFLAG} ${AM_CFLAGS} $(LINUXFLAGS)
  xlinuxtrack_la_LDFLAGS = -module -shared -fPIC -m32 $(DARWINFLAGS) -dynamiclib -export-symbols "${srcdir}/xlinuxtrack.sym" $(LINUXFLAGS) ${TIGER_LDFLAG}
  xlinuxtrack_la_LIBADD = -lm -ldl
  xlinuxtrack9_la_SOURCES = xlinuxtrack9.c linuxtrack.c
  xlinuxtrack9_la_CFLAGS = -I${XPLANE_SDK}/XPLM -I${XPLANE_SDK}/Widgets $(SYSFLAGS) -fPIC -m32 $(DARWINCFLAGS) ${TIGER_CFLAG} ${AM_CFLAGS} $(LINUXFLAGS)
  xlinuxtrack9_la_LDFLAGS = -module -shared -fPIC -m32 $(DARWINFLAGS) -dynamiclib -export-symbols "${srcdir}/xlinuxtrack.sym" $(LINUXFLAGS) ${TIGER_LDFLAG}
  xlinuxtrack9_la_LIBADD = -lm -ldl
endif
endif

AM_YFLAGS = -d
AM_LFLAGS = -i
BUILT_SOURCES = pref_flex.c pref_bison.c pref_bison.h

#dirty hack to integrate qt_gui

clean-local: clean-local-check
.PHONY: clean-local-check
clean-local-check:
	-cd qt_gui;make clean
	-cd wii_server;make clean
	rm -f linuxtrack.c

distclean-local: distclean-local-check
.PHONY: distclean-local-check
distclean-local-check:
	-cd qt_gui;make distclean
	-cd wii_server;make distclean
	rm -f linuxtrack.c

noinst_SCRIPTS = qt_gui/ltr_gui

if CWIID
  noinst_SCRIPTS += wii_server/wii_server
endif

qt_gui/ltr_gui : ${pkglib_LTLIBRARIES}
	pushd qt_gui; ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make; popd

wii_server/wii_server : ${pkglib_LTLIBRARIES}
	pushd wii_server; ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make; popd

install-exec-hook:
	pushd qt_gui;  ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make INSTALL_ROOT=${DESTDIR} install; popd
	pushd wii_server;  ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make INSTALL_ROOT=${DESTDIR} install; popd

uninstall-hook:
	pushd qt_gui;  ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make INSTALL_ROOT=${DESTDIR} uninstall; popd
	pushd wii_server;  ${QMAKE_PATH} ${QMAKE_FLAGS} "LIBDIR=$(pkglibdir)"; make INSTALL_ROOT=${DESTDIR} uninstall; popd


EXTRA_DIST = qt_gui/ltr_axis.cpp qt_gui/glwidget.h qt_gui/model_wizzard.ui \
  qt_gui/objreader.cpp qt_gui/window.h qt_gui/webcam_prefs.cpp \
  qt_gui/xm8_detail.png qt_gui/ltr_profiles.cpp qt_gui/scp_form.h \
  qt_gui/prefs_link.h qt_gui/webcam_info.cpp qt_gui/scp_form.cpp \
  qt_gui/ltr_axis.h qt_gui/main.cpp qt_gui/wiimote_prefs.h qt_gui/ltr_tracking.cpp \
  qt_gui/scurve.cpp qt_gui/ltr_state.cpp qt_gui/scurve.h qt_gui/scurve.ui \
  qt_gui/ltr_show.h qt_gui/ltr_gui.cpp qt_gui/ltr_profiles.h qt_gui/scp_form.ui \
  qt_gui/XM8_cockpit.obj qt_gui/macwebcam_prefs.cpp qt_gui/tir_prefs.cpp \
  qt_gui/macwebcam_info.h qt_gui/objreader.h qt_gui/log_view.h qt_gui/scview.cpp \
  qt_gui/ltr_dev_help.cpp qt_gui/xm8d_body.obj qt_gui/ltr_gui.h qt_gui/ltr_gui_prefs.h \
  qt_gui/wiimote_prefs.cpp qt_gui/cap.png qt_gui/ltr_model.h qt_gui/ltr_gui.ui \
  qt_gui/ltr_tracking.h qt_gui/clip.png qt_gui/log_view.cpp qt_gui/ltr_rc.qrc \
  qt_gui/ltr.ui qt_gui/dev_help.ui qt_gui/tir_prefs.h qt_gui/window.cpp \
  qt_gui/webcam_prefs.h qt_gui/macwebcam_info.cpp qt_gui/webcam_info.h \
  qt_gui/ltr_model.cpp qt_gui/ltr_gui_prefs.cpp qt_gui/ltr_show.cpp \
  qt_gui/logview.ui qt_gui/ltr_state.h qt_gui/ltr_dev_help.h qt_gui/scview.h \
  qt_gui/macwebcam_prefs.h qt_gui/glwidget.cpp qt_gui/model_creation.ui \
  tir4_driver.c tir4_driver.h 51-TIR.rules drivers.sym liblt.sym tir.sym webcam_driver.sym \
  xlinuxtrack.sym



ltr_pipe_CPPFLAGS =

if LTR_PIPE
  man_MANS += ltr_pipe.1
  bin_PROGRAMS += ltr_pipe
  ltr_pipe_CPPFLAGS += -D_GNU_SOURCE
  ltr_pipe_SOURCES = ltr_pipe.c linuxtrack.h utils.h ipc_utils.h utils.c ipc_utils.c ltlib.c ltlib.h
  ltr_pipe_CFLAGS = ${AM_CFLAGS} $(LINUXFLAGS)
  ltr_pipe_LDFLAGS = $(LINUXFLAGS) ${LTR_PIPE_FLAGS}
endif

if LINUX
  ltr_pipe_CPPFLAGS += -DLINUX
endif

desktopdir = $(datadir)/applications
desktop_DATA = linuxtrack.desktop linuxtrack-wii.desktop
icondir = $(datadir)/pixmaps
icon_DATA = linuxtrack.svg linuxtrack.png linuxtrack.xpm \
            linuxtrack-wii.svg linuxtrack-wii.png linuxtrack-wii.xpm

